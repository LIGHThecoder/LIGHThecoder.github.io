<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NM PLAY - Cloud Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: cyan; }
        .glow-effect { transition: transform 0.05s ease-out, box-shadow 0.05s ease-out, filter 0.05s ease-out; }
        #loadingOverlay { transition: opacity 0.5s ease-out; }
    </style>
</head>
<body class="min-h-screen bg-[#0a0212] text-white font-sans selection:bg-cyan-400 selection:text-black overflow-hidden">
    
    <!-- Loading Screen -->
    <div id="loadingOverlay" class="fixed inset-0 z-[200] bg-[#0a0212] flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-cyan-400 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-cyan-400 font-black uppercase tracking-widest animate-pulse">Connecting to Multiverse...</p>
    </div>

    <!-- Background Effects -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-5%] w-[70%] h-[70%] bg-blue-700/40 blur-[120px] rounded-full animate-pulse"></div>
        <div class="absolute bottom-[-10%] right-[-5%] w-[70%] h-[70%] bg-violet-800/40 blur-[120px] rounded-full animate-pulse"></div>
    </div>

    <!-- Main Container -->
    <div class="relative z-10 flex h-screen p-4 gap-4">
        <!-- Sidebar -->
        <aside class="w-20 md:w-72 bg-white/5 backdrop-blur-2xl border border-white/10 rounded-[2.5rem] flex flex-col overflow-hidden shadow-2xl">
            <div class="p-8 flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-cyan-400 via-blue-500 to-violet-600 flex items-center justify-center shadow-[0_0_20px_rgba(34,211,238,0.4)]">
                    <i data-lucide="zap" class="fill-white text-white"></i>
                </div>
                <span class="hidden md:block text-2xl font-black italic tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-white via-cyan-200 to-blue-400">NM PLAY</span>
            </div>

            <nav class="flex-1 px-4 space-y-3">
                <button onclick="showHome()" class="w-full flex items-center gap-4 p-4 rounded-2xl transition-all duration-300 bg-white/10 text-cyan-400 border border-white/10">
                    <i data-lucide="waves"></i>
                    <span class="hidden md:block font-black uppercase text-xs tracking-widest">Feed</span>
                </button>
                <button onclick="showAlbumModal()" class="w-full flex items-center gap-4 p-4 rounded-2xl text-white/40 hover:bg-cyan-500/10 hover:text-cyan-400 transition-all group">
                    <i data-lucide="plus" class="group-hover:rotate-90 transition-transform"></i>
                    <span class="hidden md:block font-black uppercase text-xs tracking-widest">Drop Album</span>
                </button>
            </nav>

            <div class="p-6">
                <div class="bg-gradient-to-br from-violet-600 to-blue-700 p-4 rounded-3xl hidden md:block">
                    <p id="userDisplay" class="text-[10px] font-black uppercase tracking-widest mb-2 opacity-70">Guest User</p>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-cyan-400 rounded-full animate-ping"></div>
                        <span class="text-xs font-bold uppercase">Cloud Synced</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden gap-4">
            <header class="h-20 bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] flex items-center justify-between px-8 shadow-xl">
                <div class="flex items-center gap-4">
                    <button onclick="showHome()" id="backBtn" class="hidden p-2 bg-white/5 hover:bg-white/10 rounded-full transition-all">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <h2 id="viewTitle" class="text-2xl font-black tracking-tighter uppercase italic">The Multiverse</h2>
                </div>
                <div id="authStatus" class="hidden sm:flex items-center gap-2 bg-black/20 px-4 py-2 rounded-full border border-white/5 text-[10px] font-bold">
                    SECURE SESSION
                </div>
            </header>

            <div id="contentArea" class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                <!-- Home View -->
                <div id="homeView" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Album cards will be injected here -->
                </div>

                <!-- Album Detail View -->
                <div id="albumView" class="hidden flex-col lg:flex-row gap-6">
                    <div class="flex-1 space-y-4">
                        <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2.5rem] p-8">
                            <div class="flex items-center justify-between mb-8">
                                <h3 class="text-2xl font-black italic tracking-tighter uppercase flex items-center gap-3">
                                    Tracklist <i data-lucide="flame" class="text-orange-500"></i>
                                </h3>
                                <div class="flex gap-2">
                                    <button onclick="deleteCurrentAlbum()" class="bg-red-500/20 text-red-400 px-4 py-3 rounded-2xl font-black uppercase text-xs hover:bg-red-500 hover:text-white transition-all">Delete Album</button>
                                    <button onclick="showSongModal()" class="bg-cyan-400 text-black px-6 py-3 rounded-2xl font-black uppercase text-xs tracking-widest hover:scale-105 transition-all">Add Track</button>
                                </div>
                            </div>
                            <div id="songList" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="w-full lg:w-80 space-y-4">
                        <div class="bg-gradient-to-br from-violet-600 to-blue-700 border border-white/10 rounded-[2.5rem] p-8 shadow-2xl">
                            <div class="flex items-center gap-2 mb-6 text-white/50 uppercase text-[10px] font-black tracking-[0.2em]">
                                <i data-lucide="file-text"></i> The Lyric Bible
                            </div>
                            <div id="lyricsDisplay" class="text-lg leading-relaxed font-bold italic text-white/90 h-[400px] overflow-y-auto custom-scrollbar pr-2">
                                Waiting for the vibes...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Player Footer -->
            <footer class="bg-white/5 backdrop-blur-[50px] border border-white/10 rounded-[2.5rem] p-4 shadow-2xl">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                        <div id="albumArt" class="w-14 h-14 flex-shrink-0 rounded-xl overflow-hidden bg-gradient-to-br from-violet-900 to-blue-900 flex items-center justify-center">
                            <i data-lucide="music" class="text-white/20"></i>
                        </div>
                        <div class="overflow-hidden min-w-0 flex-1">
                            <h5 id="nowPlayingTitle" class="font-bold text-sm truncate">No Track</h5>
                            <p id="nowPlayingArtist" class="text-xs text-white/40 truncate">Pick a vibe</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-center gap-3 flex-1">
                        <div class="flex items-center gap-6">
                            <button id="playBtn" class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 active:scale-95 transition-all disabled:opacity-30">
                                <i data-lucide="play" class="ml-0.5" style="fill: black;"></i>
                            </button>
                        </div>
                        <div class="w-full flex items-center gap-2">
                            <span id="currentTime" class="text-[10px] text-white/50 font-mono w-10 text-right">0:00</span>
                            <div id="progressBarContainer" class="flex-1 h-1 bg-white/10 rounded-full overflow-hidden cursor-pointer group">
                                <div id="progressBar" class="h-full bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full w-0 transition-all"></div>
                            </div>
                            <span id="duration" class="text-[10px] text-white/50 font-mono w-10">0:00</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 flex-1 justify-end">
                        <input type="range" id="volumeSlider" min="0" max="100" value="70" class="w-20 h-1 bg-white/10 rounded-full appearance-none cursor-pointer" style="accent-color: #22d3ee;" />
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- Modals (Album & Song) -->
    <div id="albumModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-6 bg-[#0a0212]/90 backdrop-blur-3xl">
        <div class="bg-[#1a0b2e] border border-white/10 rounded-[4rem] w-full max-w-xl p-10 relative">
            <button onclick="hideModals()" class="absolute top-10 right-10 text-white/20 hover:text-white"><i data-lucide="x"></i></button>
            <div class="space-y-8">
                <h2 class="text-5xl font-black italic uppercase leading-none">Manifest<br/><span class="text-cyan-400">Album</span></h2>
                <input id="albumTitleInput" class="w-full bg-white/5 border border-white/10 p-6 rounded-3xl outline-none focus:border-cyan-400 text-xl font-bold" placeholder="ALBUM NAME..." />
                <button onclick="handleCreateAlbum()" class="w-full bg-white text-black font-black py-6 rounded-3xl hover:bg-cyan-400 transition-all uppercase">Create Reality</button>
            </div>
        </div>
    </div>

    <div id="songModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-6 bg-[#0a0212]/90 backdrop-blur-3xl">
        <div class="bg-[#1a0b2e] border border-white/10 rounded-[4rem] w-full max-w-xl p-10 relative">
            <button onclick="hideModals()" class="absolute top-10 right-10 text-white/20 hover:text-white"><i data-lucide="x"></i></button>
            <div class="space-y-6">
                <h2 class="text-4xl font-black italic uppercase leading-none">Sync<br/><span class="text-violet-400">New Track</span></h2>
                <div class="grid grid-cols-2 gap-4">
                    <input id="songTitleInput" class="bg-white/5 border border-white/10 p-4 rounded-2xl outline-none font-bold" placeholder="TITLE" />
                    <input id="songArtistInput" class="bg-white/5 border border-white/10 p-4 rounded-2xl outline-none font-bold" placeholder="ARTIST" />
                </div>
                <textarea id="songLyricsInput" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none h-24 resize-none" placeholder="LYRICS (or paste LRC format)..."></textarea>
                <div class="flex flex-col gap-2">
                    <p class="text-[10px] text-white/40 uppercase font-black">Upload Audio (Base64 conversion)</p>
                    <input type="file" id="audioFileInput" accept="audio/*" class="text-xs text-white/40" />
                </div>
                <button id="addSongBtn" onclick="handleAddSong()" class="w-full bg-gradient-to-r from-cyan-400 to-blue-600 text-black font-black py-6 rounded-3xl transition-all uppercase">Drop It</button>
            </div>
        </div>
    </div>

    <audio id="audioPlayer"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, onSnapshot, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nm-play-default';

        // State
        let currentUser = null;
        let albums = [];
        let currentAlbumId = null;
        let currentTrack = null;

        // UI Elements
        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const progressBar = document.getElementById('progressBar');
        const homeView = document.getElementById('homeView');
        const albumView = document.getElementById('albumView');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Initialization
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('userDisplay').textContent = `User: ${user.uid.substring(0, 8)}`;
                setupDataListener();
            }
        });

        // Data Management
        const setupDataListener = () => {
            const albumsCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'albums');
            onSnapshot(albumsCol, (snapshot) => {
                albums = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHome();
                if (currentAlbumId) renderSongs();
                loadingOverlay.style.opacity = '0';
                setTimeout(() => loadingOverlay.style.display = 'none', 500);
            }, (err) => {
                console.error("Firestore Error:", err);
            });
        };

        // UI Actions (Exposed to window)
        window.showHome = () => {
            currentAlbumId = null;
            homeView.classList.remove('hidden');
            albumView.classList.add('hidden');
            document.getElementById('backBtn').classList.add('hidden');
            document.getElementById('viewTitle').textContent = 'The Multiverse';
        };

        window.showAlbumDetail = (id) => {
            currentAlbumId = id;
            homeView.classList.add('hidden');
            albumView.classList.remove('hidden');
            albumView.style.display = 'flex';
            document.getElementById('backBtn').classList.remove('hidden');
            const album = albums.find(a => a.id === id);
            document.getElementById('viewTitle').textContent = album?.title || 'Album';
            renderSongs();
        };

        window.showAlbumModal = () => document.getElementById('albumModal').classList.replace('hidden', 'flex');
        window.showSongModal = () => document.getElementById('songModal').classList.replace('hidden', 'flex');
        window.hideModals = () => {
            document.getElementById('albumModal').classList.replace('flex', 'hidden');
            document.getElementById('songModal').classList.replace('flex', 'hidden');
        };

        window.handleCreateAlbum = async () => {
            const title = document.getElementById('albumTitleInput').value.trim();
            if (!title || !currentUser) return;
            
            const albumsCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'albums');
            await addDoc(albumsCol, {
                title,
                createdAt: Date.now(),
                songs: []
            });
            window.hideModals();
            document.getElementById('albumTitleInput').value = '';
        };

        window.handleAddSong = async () => {
            const title = document.getElementById('songTitleInput').value.trim();
            const artist = document.getElementById('songArtistInput').value.trim();
            const lyrics = document.getElementById('songLyricsInput').value.trim();
            const fileInput = document.getElementById('audioFileInput');
            
            if (!title || !currentAlbumId || !currentUser) return;
            const btn = document.getElementById('addSongBtn');
            btn.disabled = true;
            btn.textContent = "Processing...";

            let audioBase64 = '';
            if (fileInput.files[0]) {
                const reader = new FileReader();
                audioBase64 = await new Promise(resolve => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(fileInput.files[0]);
                });
            }

            const albumRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'albums', currentAlbumId);
            const album = albums.find(a => a.id === currentAlbumId);
            const newSongs = [...(album.songs || []), {
                id: crypto.randomUUID(),
                title,
                artist,
                lyrics,
                audioData: audioBase64,
                addedAt: Date.now()
            }];

            await setDoc(albumRef, { songs: newSongs }, { merge: true });
            
            btn.disabled = false;
            btn.textContent = "Drop It";
            window.hideModals();
            // Clear inputs
            ['songTitleInput', 'songArtistInput', 'songLyricsInput'].forEach(id => document.getElementById(id).value = '');
            fileInput.value = '';
        };

        window.deleteCurrentAlbum = async () => {
            if (!confirm('Destroy this album forever?') || !currentUser || !currentAlbumId) return;
            const albumRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'albums', currentAlbumId);
            await deleteDoc(albumRef);
            window.showHome();
        };

        window.playTrack = (songId) => {
            const album = albums.find(a => a.id === currentAlbumId);
            const song = album.songs.find(s => s.id === songId);
            if (!song) return;

            currentTrack = song;
            audioPlayer.src = song.audioData;
            audioPlayer.play();
            
            document.getElementById('nowPlayingTitle').textContent = song.title;
            document.getElementById('nowPlayingArtist').textContent = song.artist;
            document.getElementById('lyricsDisplay').textContent = song.lyrics || 'No lyrics...';
            playBtn.innerHTML = '<i data-lucide="pause" style="fill: black;"></i>';
            lucide.createIcons();
        };

        // Renderers
        const renderHome = () => {
            homeView.innerHTML = `
                <button onclick="showAlbumModal()" class="aspect-square rounded-[3rem] border-2 border-dashed border-white/20 flex flex-col items-center justify-center gap-4 text-white/20 hover:border-cyan-400 hover:text-cyan-400 transition-all group bg-white/5">
                    <i data-lucide="plus" style="width: 32px; height: 32px;"></i>
                    <span class="font-black text-[10px] uppercase tracking-[0.3em]">Manifest Album</span>
                </button>
            `;
            albums.forEach(album => {
                const card = document.createElement('div');
                card.className = "group relative aspect-square bg-white/5 border border-white/10 rounded-[3rem] p-8 flex flex-col justify-end overflow-hidden cursor-pointer hover:border-cyan-400/50 transition-all shadow-2xl";
                card.onclick = () => window.showAlbumDetail(album.id);
                card.innerHTML = `
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent z-10"></div>
                    <div class="relative z-20">
                        <p class="text-[10px] font-black uppercase tracking-widest text-cyan-400 mb-2">${album.songs?.length || 0} Vibes</p>
                        <h4 class="text-2xl font-black italic tracking-tighter uppercase leading-none text-white group-hover:text-cyan-400 transition-colors">${album.title}</h4>
                    </div>
                `;
                homeView.appendChild(card);
            });
            lucide.createIcons();
        };

        const renderSongs = () => {
            const list = document.getElementById('songList');
            const album = albums.find(a => a.id === currentAlbumId);
            if (!album || !album.songs?.length) {
                list.innerHTML = '<p class="text-white/40 text-center py-8">No tracks yet. Add some!</p>';
                return;
            }
            list.innerHTML = '';
            album.songs.forEach((song, idx) => {
                const row = document.createElement('div');
                row.className = "flex items-center justify-between p-4 bg-white/5 hover:bg-white/10 rounded-2xl cursor-pointer group transition-all";
                row.onclick = () => window.playTrack(song.id);
                row.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-xs font-black text-white/20 w-4">${idx + 1}</span>
                        <div>
                            <p class="font-bold text-sm">${song.title}</p>
                            <p class="text-[10px] text-white/40 uppercase font-black">${song.artist}</p>
                        </div>
                    </div>
                    <i data-lucide="play-circle" class="text-cyan-400 opacity-0 group-hover:opacity-100 transition-all"></i>
                `;
                list.appendChild(row);
            });
            lucide.createIcons();
        };

        // Global Event Listeners
        playBtn.onclick = () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                playBtn.innerHTML = '<i data-lucide="pause" style="fill: black;"></i>';
            } else {
                audioPlayer.pause();
                playBtn.innerHTML = '<i data-lucide="play" style="fill: black;"></i>';
            }
            lucide.createIcons();
        };

        audioPlayer.ontimeupdate = () => {
            const p = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = `${p}%`;
            document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
        };

        audioPlayer.onloadedmetadata = () => {
            document.getElementById('duration').textContent = formatTime(audioPlayer.duration);
        };

        document.getElementById('progressBarContainer').onclick = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = pct * audioPlayer.duration;
        };

        document.getElementById('volumeSlider').oninput = (e) => {
            audioPlayer.volume = e.target.value / 100;
        };

        const formatTime = (s) => {
            if (isNaN(s)) return '0:00';
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        };

        // Start Auth
        initAuth();
        lucide.createIcons();
    </script>
</body>
</html>